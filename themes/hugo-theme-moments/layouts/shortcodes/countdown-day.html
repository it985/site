{{ $startDate := .Get "startDate" }}
{{ $endDate := .Get "endDate" }}
{{ $title := .Get "title" | default "目标日期" }}
{{ $id := .Page.Date.Unix }}

<div class="countdown-day" id="{{ $id }}">
    <div class="memorial-header">
        <span class="countdown-title">Calculating...</span>
    </div>
    
    <div class="memorial-counter">
        <div class="counter-number">-</div>
    </div>
    
    <div class="memorial-footer">
        <div class="target-date">
            <span class="date-info">Calculating...</span>
        </div>
    </div>
</div>

<script>
(function() {
    const widgetId = '{{ $id }}';
    const startDate = '{{ $startDate }}';
    const endDate = '{{ $endDate }}';
    const title = '{{ $title }}';
    const pubDate = '{{ .Page.Date.Format "2006-01-02" }}';
    
    function parseDate(dateStr) {
        switch(dateStr) {
            case 'viewDate':
                return new Date();
            case 'pubDate':
                return new Date(pubDate);
            default:
                // Assume standard date format YYYY-MM-DD
                return new Date(dateStr);
        }
    }
    
    function getDaysDifference(date1, date2) {
        // Create new Date objects with time set to 00:00:00
        const d1 = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
        const d2 = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
        
        // Calculate millisecond difference, then convert to days
        const diffInMs = d2.getTime() - d1.getTime();
        return Math.floor(diffInMs / (1000 * 60 * 60 * 24));
    }
        
    function calculateDays() {
        const startDateObj = parseDate(startDate);
        const endDateObj = parseDate(endDate);
        const daysDiff = getDaysDifference(startDateObj, endDateObj);
        
        return {
            days: daysDiff,
            startDateObj: startDateObj,
            endDateObj: endDateObj
        };
    }
    
    function formatDateInfo(dateStr, date) {
        if (dateStr === 'viewDate') {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const weekday = weekdays[date.getDay()];
            return `今天(${year}-${month}-${day} ${weekday})`;
        } else {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const weekday = weekdays[date.getDay()];
            return `${year}-${month}-${day} ${weekday}`;
        }
    }

    function adjustFontSize(element) {
        const container = element.parentElement;
        const containerWidth = container.clientWidth - 20; // Subtract padding
        
        // Set initial font size
        let fontSize = 120;
        element.style.fontSize = fontSize + 'px';
        
        // Gradually decrease font size until text fits container width
        while (element.scrollWidth > containerWidth && fontSize > 80) {
            console.log(fontSize)
            fontSize -= 10;
            element.style.fontSize = fontSize + 'px';
        }
        
        // If font is too small, try to increase it
        while (element.scrollWidth < containerWidth && fontSize < 24) {
            const testSize = fontSize + 0.5;
            element.style.fontSize = testSize + 'px';
            
            if (element.scrollWidth > containerWidth) {
                element.style.fontSize = fontSize + 'px';
                break;
            }
            fontSize = testSize;
        }
    }
    
    function updateDisplay() {
        const widget = document.getElementById(widgetId);
        if (!widget) return;
        
        const result = calculateDays();
        const counterElement = widget.querySelector('.counter-number');
        const dateInfoElement = widget.querySelector('.date-info');
        const titleElement = widget.querySelector('.countdown-title');
        const headerElement = widget.querySelector('.memorial-header');
        
        // Update days display
        counterElement.textContent = Math.abs(result.days);
        
        // Update title and background color: based on the relationship between startDate and endDate
        let prefix = "";
        if (result.days >= 0) {
            // startDate <= endDate: countdown logic
            titleElement.textContent = `距 ${title} 还有`;
            headerElement.classList.remove('past');
            prefix = '目标日';
        } else {
            // startDate > endDate: elapsed time logic
            titleElement.textContent = `距 ${title} 已经`;
            headerElement.classList.add('past');
            prefix = '起始日';
        }
        
        // Update date information
        const startInfo = formatDateInfo(startDate, result.startDateObj);
        const endInfo = formatDateInfo(endDate, result.endDateObj);
        
        if (startDate === 'viewDate' && endDate !== 'viewDate') {
            dateInfoElement.textContent = `${prefix}: ${endInfo}`;
        } else if (startDate !== 'viewDate' && endDate === 'viewDate') {
            dateInfoElement.textContent = `${prefix}: ${startInfo}`;
        } else if (startDate === 'viewDate' && endDate === 'viewDate') {
            dateInfoElement.textContent = startInfo;
        } else {
            dateInfoElement.textContent = `${startInfo} → ${endInfo}`;
        }


        const numberElement = widget.querySelector(".counter-number");
        adjustFontSize(numberElement);
    }
    
    
    // Execute after DOM is loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateDisplay);
    } else {
        updateDisplay();
    }
})();
</script>